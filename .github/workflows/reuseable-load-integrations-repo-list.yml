# Reusable Workflow
name: R - Load Integrations Repo List

# Export list of repositories to check.
# Reads the list of integrations from ./.github/integrations.json
# Use `repo-list.sh` in `integration-tests` to generate.

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Branch or hash
        required: false
  workflow_call:
    inputs:
      ref:
        required: false
        type: string
    outputs:
      repos:
        description: JSON list of integration test repositories
        value: ${{ jobs.load.outputs.repos }}
      ref:
        description: Branch or ref used
        value: ${{ jobs.load.outputs.ref }}

permissions:
  contents: read

env:
  RUNS_ON: ubuntu-latest
  NODE_VERSION: "16.x"
  NPM_VERSION: "8"

jobs:
  load:
    runs-on: ubuntu-latest
    env:
      REF_BRANCH: ${{ inputs.ref || github.event.inputs.ref }}
    outputs:
      repos: ${{ env.REPOS }}
      ref: ${{ env.REF_BRANCH }}

    steps:
      - name: Inputs
        env:
          INPUTS: ${{ toJSON(inputs || github.event.inputs) }}
        run: |
          echo "inputs: $INPUTS"

      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ env.REF_BRANCH }}

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - run: npm i -g npm@${{ env.NPM_VERSION }}
      - run: npm -v

      - name: Update Integrations List
        run: |
          npm run update-integrations-list

      - id: read-integrations
        run: |
          echo "REPOS<<HEREDOC" >> $GITHUB_ENV
          echo "$(cat .github/integrations.json)" >> $GITHUB_ENV
          echo HEREDOC >> $GITHUB_ENV

      - name: Show List
        run: |
          echo "$REPOS"
