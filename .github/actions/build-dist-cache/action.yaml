name: Build and Cache Dist
description: Build the repo and store it in the cache.

inputs:
  show-summary:
    description: Show a build summary.
    required: false

outputs:
  key:
    description: Cache Key
    value: ${{ steps.cache-key.outputs.value }}
  path:
    description: Cache Path
    value: ${{ steps.cache-path.outputs.value }}
  cache-hit:
    description: |
      Indicates that the cache was hit.
      Return values:
      - 'true' - the cache was used.
      - '' - the cache was not used.
    value: ${{ steps.step-cache-build.outputs.cache-hit }}

runs:
  using: "composite"

  steps:
    - name: Inputs
      shell: bash
      env:
        INPUTS: ${{ toJSON(inputs || github.event.inputs) }}
      run: |
        echo "inputs: $INPUTS"

    - run: pnpm i
      shell: bash

    - name: Calc Key and Path
      shell: bash
      id: key_and_path
      run: |
        echo "CACHE_PATH<<CACHE_PATH
        packages/*/dist
        integration-tests/dist
        CACHE_PATH" >> $GITHUB_ENV
        echo "CACHE_KEY=integrations-build-${{ hashFiles(
            'integration-tests/src/**/*.ts', 'integration-tests/tsconfig.json',
            '*-lock.yaml', 'packages/*/src/**/*.ts', 'packages/*/tsconfig.json'
          ) }}" >> $GITHUB_ENV

    - id: cache-path
      uses: ./.github/actions/output
      with:
        value: ${{ env.CACHE_PATH }}
        show: true

    - id: cache-key
      uses: ./.github/actions/output
      with:
        value: ${{ env.CACHE_KEY }}
        show: true

    - name: Cache Build
      id: step-cache-build
      uses: actions/cache@v3
      with:
        key: ${{ env.CACHE_KEY }}
        path: ${{ env.CACHE_PATH }}

    - name: Cached Results
      run: |
        echo Build Cache: ${{ steps.step-cache-build.outputs.cache-hit && 'Hit' || 'Miss' }}
      shell: bash

    - name: Pnpm CI
      if: ${{ !steps.step-cache-build.outputs.cache-hit }}
      run: pnpm i
      shell: bash

    - name: Has Pnpm has failed?
      if: ${{ failure() }}
      run: |
        ls -alF /home/runner/.pnpm/_logs/*.log
        cat /home/runner/.pnpm/_logs/*.log
      shell: bash

    - name: Build
      if: ${{ !steps.step-cache-build.outputs.cache-hit }}
      run: pnpm run build
      shell: bash

    - name: Summary
      if: inputs.show-summary == 'true'
      uses: ./.github/actions/summary
      with:
        text: |
          ## Build
          - key: ${{ env.CACHE_KEY }}
          - path:
          ```
          ${{ env.CACHE_PATH }}
          ```
          - hit: ${{ steps.step-cache-build.outputs.cache-hit || 'Miss' }}
