name: Simple Workflow Debounce
description: Determine if a workflow / job should run.

inputs:
  tag:
    description: Optional name of the debounce tag.
    required: false
  hash:
    description: Optional hash as part debounce tag.
    required: false
  timeout:
    description: The timeout in seconds. Defaults to 60.
    required: false
  debug:
    description: Show Debug Info
    required: false
outputs:
  ok:
    description: Returns `true` if it is "oK" to run the workflow/job, otherwise ''.
    value: ${{ !!inputs.tag || '' }}
  bock:
    description: Returns `true` if the workflow/job should be dropped, otherwise ''.
    value: ${{ !inputs.tag || '' }}

runs:
  using: "composite"
  steps:
    - name: Show Input
      if: inputs.debug
      shell: bash
      env:
        INPUTS: ${{ toJSON(inputs) }}
        RUNNER: ${{ toJSON(runner) }}
      run: |
        echo "$debug"
        echo "$RUNNER"

    - name: Calc timeout
      id: timeout
      uses: ./.github/actions/output
      with:
        value: ${{ inputs.timeout || 60 }}

    - name: Calc Timestamp
      # Do all the math. It is not currently possible to do any arithmetic in the workflow expressions.
      id: timestamp
      shell: bash
      run: |
        export TIMESTAMP=$(date +%s.%6N)
        echo timestamp-double=$TIMESTAMP >> $GITHUB_OUTPUT
        echo timestamp=$(echo $TIMESTAMP / 1 | bc) >> $GITHUB_OUTPUT
        echo timeout-before=$(echo $TIMESTAMP / ${{steps.timeout.outputs.value}} | bc) >> $GITHUB_OUTPUT
        echo block=$(echo $TIMESTAMP / ${{steps.timeout.outputs.value}} | bc) >> $GITHUB_OUTPUT
        echo block-prev=$(echo $TIMESTAMP / ${{steps.timeout.outputs.value}} - 1 | bc) >> $GITHUB_OUTPUT

    - name: Show Timestamp
      if: inputs.debug
      uses: ./.github/actions/echo
      with:
        value: ${{ toJSON(steps.timestamp.outputs) }}

    - name: Make Cache Content
      id: timestamp_info
      uses: ./.github/actions/output
      with:
        value: |
          {
            "timestamp": ${{steps.timestamp.outputs.timestamp}},
            "timestamp-double": ${{steps.timestamp.outputs.timestamp-double}},
            "timeout-before": ${{steps.timestamp.outputs.timeout-before}},
            "block": ${{steps.timestamp.outputs.block}},
            "block-prev": ${{steps.timestamp.outputs.block-prev}},

            "run_id": "${{github.run_id}}",
            "run_number": ${{github.run_number}},
            "run_attempt": ${{github.run_attempt}}
          }

    - name: Show Cache Content
      if: inputs.debug
      uses: ./.github/actions/echo
      with:
        value: ${{ steps.timestamp_info.outputs.value }}

    - name: Set Variables
      shell: bash
      run: |
        echo "_debounce_timestamp-double=${{ fromJSON(steps.timestamp_info.outputs.value).timestamp-double }}" >> $GITHUB_ENV
        echo "_debounce_block=${{ fromJSON(steps.timestamp_info.outputs.value).block }}" >> $GITHUB_ENV
        echo "_debounce_block-prev=${{ fromJSON(steps.timestamp_info.outputs.value).block-prev }}" >> $GITHUB_ENV
        echo "_debounce_timeout-before=${{ fromJSON(steps.timestamp_info.outputs.value).timeout-before }}" >> $GITHUB_ENV

    - name: Calc Filename
      id: cache-path
      uses: ./.github/actions/output
      with:
        value: ${{ runner.temp }}/_debounce-${{ fromJSON(steps.timestamp_info.outputs.value).timestamp-double }}

    - id: cache-key
      uses: streetsidesoftware/action-set-output@v1
      with:
        value: >-
          debounce-${{ inputs.tag }}-${{ inputs.hash }}
        debug: true

    - name: Show Filename
      if: inputs.debug
      uses: ./.github/actions/echo
      with:
        value: ${{ steps.cache-path.outputs.value }}

    - name: Try to restore the cache entry
      uses: actions/cache/restore@v3
      id: cache-main
      with:
        key: ${{ steps.cache-key.outputs.value }}-stub
        path: ${{ steps.cache-path.outputs.value }}
        restore-keys: |
          ${{ steps.cache-key.outputs.value }}

    - name: Should we go forward?
      id: stop-1
      uses: ./.github/actions/output
      with:
        value: ${{ !steps.cache-main.outputs.cache-hit || '' }}

    # - name: Cached Results
    #   if: inputs.debug
    #   uses: ./.github/actions/echo
    #   with:
    #     value: >-
    #       Cache: ${{ toJSON(steps.cache) }}

    # - name: Write Timestamp
    #   shell: bash
    #   run: |
    #     date +%s > ${{ steps.cache-path.outputs.value }}

    # - name: Save Cache
    #   id: cache_save
    #   uses: actions/cache/save@v3
    #   with:
    #     key: ${{ steps.cache-key.outputs.value }}-${{github.run_id}}-${{github.run_number}}-${{github.run_attempt}}
    #     path: ${{ steps.cache-path.outputs.value }}

    # - name: Cache Save Results
    #   if: inputs.debug
    #   uses: ./.github/actions/echo
    #   with:
    #     value: >-
    #       Cache: ${{ toJSON(steps.cache_save) }}

    # - uses: actions/cache/restore@v3
    #   id: cache-restore
    #   with:
    #     key: ${{ steps.cache-key.outputs.value }}-${{github.run_id}}-${{github.run_number}}-${{github.run_attempt}}
    #     path: ${{ steps.cache-path.outputs.value }}
    #     restore-keys: |
    #       ${{ steps.cache-key.outputs.value }}

    # - name: Cached Results
    #   if: inputs.debug
    #   uses: ./.github/actions/echo
    #   with:
    #     value: >-
    #       Cache: ${{ toJSON(steps.cache-restore) }}

    - name: Clean Up
      shell: bash
      run: echo "" > $GITHUB_ENV
